packages:
  yum:
    certbot: []
    python3-certbot-nginx: []

commands:
  # Let's Encrypt 인증서 설치 (인증서가 없는 경우에만)
  01_install_certificate:
    command: |
      if [ ! -d /etc/letsencrypt/live/api.scentist.link ]; then
        certbot certonly --standalone --non-interactive --agree-tos --email your-email@example.com -d api.scentist.link --pre-hook "systemctl stop nginx" --post-hook "systemctl start nginx"
      fi
    ignoreErrors: true

  # 인증서 갱신 테스트
  02_test_certificate_renewal:
    command: "certbot renew --dry-run"
    ignoreErrors: true

files:
  # 인증서 자동 갱신을 위한 cron 작업 설정
  "/etc/cron.d/certbot-renew":
    mode: "000644"
    owner: root
    group: root
    content: |
      0 3 * * * root certbot renew --quiet --no-self-upgrade --pre-hook "systemctl stop nginx" --post-hook "systemctl start nginx"

  # 인증서 갱신 후 Nginx 재시작을 위한 hook 스크립트
  "/etc/letsencrypt/renewal-hooks/post/nginx-reload.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      systemctl restart nginx