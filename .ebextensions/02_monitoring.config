files:
  "/tmp/install_monitoring.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # 필요한 패키지 설치
      yum update -y
      yum install -y docker
      
      # Docker 시작 및 활성화
      service docker start
      chkconfig docker on
      
      # 노드 익스포터 설치
      docker run -d --name node-exporter \
        --restart=always \
        --net="host" \
        --pid="host" \
        -v "/proc:/host/proc:ro" \
        -v "/sys:/host/sys:ro" \
        -v "/:/rootfs:ro" \
        prom/node-exporter:latest \
        --path.procfs=/host/proc \
        --path.rootfs=/rootfs \
        --path.sysfs=/host/sys \
        --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
      
      # Pinpoint 에이전트 설정 디렉토리 생성
      mkdir -p /opt/pinpoint-agent
      
      # Pinpoint 에이전트 다운로드
      curl -L -o /tmp/pinpoint-agent.tar.gz "https://github.com/pinpoint-apm/pinpoint/releases/download/v2.5.0/pinpoint-agent-2.5.0.tar.gz"
      tar -xzvf /tmp/pinpoint-agent.tar.gz -C /opt/pinpoint-agent --strip-components=1
      rm /tmp/pinpoint-agent.tar.gz
      
      # Pinpoint 에이전트 설정 파일 수정 (모니터링 서버 IP는 나중에 업데이트됨)
      sed -i "s/profiler.collector.ip=127.0.0.1/profiler.collector.ip=MONITORING_SERVER_IP/g" /opt/pinpoint-agent/pinpoint-bootstrap.config
      
      # 접근 권한 설정
      chmod -R 755 /opt/pinpoint-agent
      chown -R webapp:webapp /opt/pinpoint-agent

option_settings:
  aws:elasticbeanstalk:application:environment:
    MONITORING_SERVER_IP: "${MONITORING_SERVER_IP}"
    JAVA_TOOL_OPTIONS: "-javaagent:/opt/pinpoint-agent/pinpoint-bootstrap.jar -Dpinpoint.agentId=pick-perfume-be -Dpinpoint.applicationName=pick_perfume_be -Dfile.encoding=UTF-8 -Xms1024m -Xmx1024m"

commands:
  01_install_monitoring:
    command: "/tmp/install_monitoring.sh"
    ignoreErrors: false
  02_update_pinpoint_config:
    command: "sed -i \"s/MONITORING_SERVER_IP/$MONITORING_SERVER_IP/g\" /opt/pinpoint-agent/pinpoint-bootstrap.config"
    ignoreErrors: false 