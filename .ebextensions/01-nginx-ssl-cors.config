files:
  # Nginx SSL 및 CORS 설정
  "/etc/nginx/sites-enabled/api-domain.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
          listen 80;
          server_name api.scentist.link;
          return 301 https://$host$request_uri;
      }

      server {
          listen 443 ssl;
          server_name api.scentist.link;

          ssl_certificate /etc/letsencrypt/live/api.scentist.link/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/api.scentist.link/privkey.pem;

          # CORS 헤더 추가
          add_header 'Access-Control-Allow-Origin' 'https://scentist.link' always;
          add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
          add_header 'Access-Control-Allow-Headers' '*' always;
          add_header 'Access-Control-Allow-Credentials' 'true' always;

          # OPTIONS 요청 처리
          if ($request_method = 'OPTIONS') {
              return 204;
          }

          # 모든 요청을 백엔드로 전달
          location / {
              proxy_pass http://localhost:5000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Forwarded-Port $server_port;
              proxy_buffer_size 128k;
              proxy_buffers 4 256k;
              proxy_busy_buffers_size 256k;
          }
      }

  # Elastic Beanstalk의 기본 애플리케이션 설정을 비활성화
  "/etc/nginx/conf.d/elasticbeanstalk/00_application.conf.disabled":
    mode: "000644"
    owner: root
    group: root
    content: |
      # This file is intentionally empty to disable the default Elastic Beanstalk Nginx configuration
      # The actual configuration is in /etc/nginx/sites-enabled/api-domain.conf

container_commands:
  # Nginx 설정을 위한 디렉토리 생성
  01_create_sites_enabled_dir:
    command: "mkdir -p /etc/nginx/sites-enabled"

  # Nginx 설정 파일에 sites-enabled 포함 설정 추가
  02_add_sites_enabled_to_nginx_conf:
    command: "grep -q 'sites-enabled' /etc/nginx/nginx.conf || sed -i '/include.*conf.d.*/a\\    include /etc/nginx/sites-enabled/*.conf;' /etc/nginx/nginx.conf"

  # 기존 Elastic Beanstalk Nginx 설정 비활성화
  03_disable_eb_nginx_config:
    command: "if [ -f /etc/nginx/conf.d/elasticbeanstalk/00_application.conf ]; then mv /etc/nginx/conf.d/elasticbeanstalk/00_application.conf /etc/nginx/conf.d/elasticbeanstalk/00_application.conf.disabled; fi"
    ignoreErrors: true

  # Nginx 설정 테스트 및 재시작
  04_test_and_reload_nginx:
    command: "nginx -t && systemctl restart nginx"
    ignoreErrors: true